<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>TRPG HTML 뷰티파이어</title>
<style>
body { font-family: sans-serif; margin: 20px; }
.controls { margin-bottom: 10px; }
.style-controls label { display: block; margin: 5px 0; }
#editor { width: 100%; height: 200px; font-family: monospace; margin: 10px 0; }
#previewFrame { width: 100%; height: 500px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h1>TRPG HTML 뷰티파이어 & 실시간 미리보기</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".html">
  <button id="beautifyBtn">뷰티파이</button>
  <button id="downloadBtn">다운로드</button>
</div>

<h2>스타일 옵션</h2>
<div class="style-controls">
  <label>span 배경색: <input type="color" id="spanBgColor" value="#000000"></label>
  <label>span 글자색: <input type="color" id="spanColor" value="#ffffff"></label>
  <label>span padding(px): <input type="number" id="spanPadding" value="5"></label>
  <label>span 글꼴 크기(px): <input type="number" id="spanFontSize" value="14"></label>
  <label>b 글자색: <input type="color" id="bColor" value="gray"></label>
  <label>span,b 글꼴: <input type="text" id="fontFamily" value="Arial"></label>
  <label>span,b 줄간격(line-height): <input type="number" step="0.1" id="lineHeight" value="1.5"></label>
  <label>.gap padding(px): <input type="number" id="gapPadding" value="16"></label>
  <label>.gap align-items: 
    <select id="gapAlign">
      <option value="flex-start">flex-start</option>
      <option value="center">center</option>
      <option value="flex-end">flex-end</option>
    </select>
  </label>
  <label>.ccfolia_wrap 배경색: <input type="color" id="wrapBg" value="#2c2c2cde"></label>
  <label>.msg_container 배경색: <input type="color" id="msgBg" value="#00000033"></label>
</div>

<h2>렌더링 미리보기</h2>
<iframe id="previewFrame"></iframe>

<textarea id="editor" placeholder="HTML 코드 편집용"></textarea>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // 요소 선택
  const fileInput = document.getElementById("fileInput");
  const editor = document.getElementById("editor");
  const previewFrame = document.getElementById("previewFrame");
  const beautifyBtn = document.getElementById("beautifyBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const spanBgColor = document.getElementById("spanBgColor");
  const spanColor = document.getElementById("spanColor");
  const spanPadding = document.getElementById("spanPadding");
  const spanFontSize = document.getElementById("spanFontSize");
  const bColor = document.getElementById("bColor");
  const fontFamily = document.getElementById("fontFamily");
  const lineHeight = document.getElementById("lineHeight");
  const gapPadding = document.getElementById("gapPadding");
  const gapAlign = document.getElementById("gapAlign");
  const wrapBg = document.getElementById("wrapBg");
  const msgBg = document.getElementById("msgBg");

  let htmlContent = "";

  // ----------------------------
  // HTML 파일 읽기
  // ----------------------------
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      htmlContent = event.target.result;
      editor.value = htmlContent;
      updatePreview();
    };
    reader.readAsText(file);
  });

  // ----------------------------
  // 실시간 미리보기
  // ----------------------------
  function updatePreview() {
    const style = `
      <style>
        .ccfolia_wrap { background-color: ${wrapBg.value}; }
        .msg_container { background: ${msgBg.value}; }
        span { background: ${spanBgColor.value}; color: ${spanColor.value}; padding: ${spanPadding.value}px; font-size: ${spanFontSize.value}px; font-family: ${fontFamily.value}; line-height: ${lineHeight.value}; }
        b { color: ${bColor.value}; font-family: ${fontFamily.value}; line-height: ${lineHeight.value}; }
        span, b { font-family: ${fontFamily.value}; line-height: ${lineHeight.value}; }
        .gap { padding: ${gapPadding.value}px; align-items: ${gapAlign.value}; display: flex; }
        hr { display: none !important; }
      </style>
    `;
    previewFrame.srcdoc = "<!DOCTYPE html><html><head>" + style + "</head><body>" + editor.value + "</body></html>";
  }

  editor.addEventListener("input", () => {
    htmlContent = editor.value;
    updatePreview();
  });

  [spanBgColor, spanColor, spanPadding, spanFontSize,
   bColor, fontFamily, lineHeight, gapPadding, gapAlign, wrapBg, msgBg
  ].forEach(el => el.addEventListener("input", updatePreview));

  // ----------------------------
  // 뷰티파이
  // ----------------------------
  beautifyBtn.addEventListener("click", () => {
    htmlContent = beautifyHTML(editor.value);
    editor.value = htmlContent;
    updatePreview();
  });

  function beautifyHTML(code) {
    const tab = "  ";
    let result = "", indent = 0;
    code.split(/>\s*</).forEach((element) => {
      if (element.match(/^\/\w/)) indent--;
      result += tab.repeat(indent) + "<" + element + ">\n";
      if (element.match(/^<?\w[^>]*[^\/]$/) && !element.startsWith("!")) indent++;
    });
    result = result.replace(/<hr[^>]*>/gi, '');
    return result.trim();
  }

  // ----------------------------
  // 다운로드
  // ----------------------------
  downloadBtn.addEventListener("click", () => {
    const blob = new Blob([editor.value], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "modified.html";
    a.click();
    URL.revokeObjectURL(url);
  });

});
</script>
</body>
</html>
